<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CO-YUM — Sandwiches & Affiliate</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    /* Dark, minimalist UI with blue accents */
    :root{
      --bg:#000000;
      --card:#0b0b0f;
      --muted:#95a0b3;
      --text:#ffffff;
      --accent:#1e90ff; /* dodger blue */
      --accent-2:#08a0ff;
      --glass: rgba(255,255,255,0.03);
      --radius:14px;
      --shadow: 0 10px 30px rgba(2,6,23,0.6);
      --success:#22c55e;
      --warning:#f59e0b;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:Inter, 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased}
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    header{position:sticky;top:0;z-index:40;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,0.03)}
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:14px 10px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#021225;font-size:18px;box-shadow:0 6px 18px rgba(30,144,255,0.12)}
    h1{font-size:18px;margin:0;color:var(--text)}
    nav{display:flex;gap:10px;align-items:center}
    .nav-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:var(--muted);cursor:pointer;font-weight:700;transition: all 0.16s ease}
    .nav-btn:hover{background:rgba(255,255,255,0.02); color:var(--text)}
    .nav-btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#021225;border:none}
    .nav-btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    main{padding:22px 0}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:22px}
    @media(max-width:980px){ .grid{grid-template-columns:1fr} .sidebar{position:static} }
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.03);box-shadow:var(--shadow)}
    .card h2{margin:0 0 8px;font-weight:700}
    .small{font-size:13px;color:var(--muted)}
    .products{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
    .product{
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);
      transition: transform 180ms ease, box-shadow 180ms ease;
      position:relative;
      display:flex;flex-direction:column; min-height:320px;
    }
    .product:hover{ transform: translateY(-6px); box-shadow: 0 20px 40px rgba(2,6,23,0.6) }
    .img-wrap{position:relative;overflow:hidden;height:160px;background:linear-gradient(120deg, rgba(30,144,255,0.04), rgba(8,160,255,0.02)); display:flex;align-items:center;justify-content:center}
    .product img{width:100%;height:160px;object-fit:cover;display:block;transition: transform 300ms ease}
    .badge{ position:absolute; left:12px; top:12px; padding:8px 10px; border-radius:999px; font-weight:800; font-size:12px; background:rgba(2,6,23,0.6); color:var(--text); border:1px solid rgba(255,255,255,0.04) }
    .product .body{padding:14px; display:flex;flex-direction:column; gap:10px; flex:1}
    .title{font-weight:800; font-size:16px; color:var(--text)}
    .desc{color:var(--muted);font-size:13px;margin-top:2px}
    .product .footer{display:flex;justify-content:space-between;align-items:center;margin-top:auto}
    .price{font-weight:900;color:var(--accent); font-size:16px}
    .btn{background:var(--accent);border:none;padding:8px 12px;border-radius:10px;color:#021225;font-weight:800;cursor:pointer;transition: all 0.18s ease;box-shadow:0 8px 20px rgba(30,144,255,0.08)}
    .btn:hover{background:var(--accent-2); transform: translateY(-2px)}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .sidebar{position:sticky;top:90px}
    .cart-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px dashed rgba(255,255,255,0.03)}
    .muted{color:var(--muted)}
    .center{text-align:center}
    input,textarea,select{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px;border-radius:8px;color:var(--text);width:100%;transition: all 0.2s ease}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 4px rgba(30,144,255,0.06)}
    .flex{display:flex;gap:10px}
    .flex-between{display:flex;justify-content:space-between;align-items:center}
    .referral-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.03)}
    .status-pending { color: var(--warning) }
    .status-confirmed { color: var(--success) }
    .status-paid { color: var(--accent) }
    footer{padding:18px;text-align:center;color:var(--muted);margin-top:20px;border-top:1px solid rgba(255,255,255,0.03)}
    @media (max-width:768px){
      .container{padding:12px}
      .header-row{flex-direction:column;gap:10px;padding:10px 0}
      nav{flex-wrap:wrap;justify-content:center}
      .grid{gap:14px}
      .products{grid-template-columns:1fr}
      .sidebar{position:static}
    }
  </style>
</head>
<body>
  <div id="notification" style="position:fixed;right:18px;top:18px;z-index:120;display:none">
    <div style="background:var(--card);border-radius:10px;padding:10px 14px;border:1px solid rgba(255,255,255,0.04);box-shadow:var(--shadow)"><span id="notificationText" style="color:var(--text)"></span></div>
  </div>

  <header>
    <div class="container">
      <div class="header-row">
        <div class="brand">
          <div class="logo">CY</div>
          <div>
            <h1>CO-YUM</h1>
            <div class="small muted">Fresh sandwiches — affiliates first</div>
          </div>
        </div>

        <nav>
          <div style="display:flex;align-items:center;gap:8px">
            <input id="searchInput" placeholder="Search menu" style="min-width:200px;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)">
            <button id="clearSearch" class="nav-btn ghost" title="Clear"><i class="fas fa-times"></i></button>
          </div>

          <div id="welcome" class="small muted" style="margin-left:8px">Not logged in</div>
          <button id="loginBtn" class="nav-btn"><i class="fas fa-user"></i>&nbsp;Login</button>
          <button id="openAffiliate" class="nav-btn" style="background:transparent;border:1px solid rgba(30,144,255,0.14);color:var(--accent)"><i class="fas fa-users"></i>&nbsp;Affiliate</button>
          <button id="openAdmin" class="nav-btn"><i class="fas fa-cog"></i></button>
        </nav>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="grid">
        <!-- left column -->
        <div>
          <div class="card">
            <div class="flex-between">
              <div>
                <h2>Menu</h2>
                <div class="small muted">Succinct. Fast. Clear.</div>
              </div>
              <div class="small muted"><i class="fas fa-phone"></i>&nbsp;Seller: <span id="sellerPhoneDisplay">+2348103606602</span></div>
            </div>

            <div style="margin-top:14px" id="products" class="products"></div>
          </div>

          <div class="card" style="margin-top:14px">
            <h3 style="margin:0 0 8px">How it works</h3>
            <div class="small muted">
              <ul style="margin:6px 0 0 18px;padding:0">
                <li>Login with an OPAY account (demo).</li>
                <li>Refer friends via link or add their account — earn when they buy.</li>
                <li>Checkout opens WhatsApp with your order pre-filled.</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- right column / sidebar -->
        <aside class="sidebar">
          <div class="card">
            <h3>Your Cart</h3>
            <div id="cartList" style="margin-top:10px"><div class="center small muted">Cart is empty</div></div>
            <div class="cart-total" style="margin-top:12px">
              <div class="small">Total:</div>
              <div id="cartTotal" class="small" style="font-weight:900">₦0</div>
            </div>
            <div style="margin-top:12px">
              <button id="checkoutBtn" class="btn" style="width:100%"><i class="fab fa-whatsapp"></i>&nbsp;Checkout</button>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>Your Profile</h3>
            <div style="margin-top:8px" class="small muted">
              <div class="flex-between"><span>Account:</span><span id="acctNumber">—</span></div>
              <div class="flex-between" style="margin-top:6px"><span>Purchases (local):</span><span id="weekPurchases">0</span></div>
              <div class="flex-between" style="margin-top:6px"><span>Affiliate:</span><span>₦<span id="affiliateBalance">0</span></span></div>
            </div>
            <div style="margin-top:12px"><button id="viewHistory" class="nav-btn" style="width:100%"><i class="fas fa-history"></i>&nbsp;History</button></div>
          </div>

          <div class="card" style="margin-top:12px; border-left:4px solid var(--accent);">
            <h3 style="margin:0 0 8px"><i class="fas fa-link"></i> Affiliate</h3>
            <div class="small muted">Earn ₦500 per confirmed referral (default)</div>

            <div style="margin-top:12px">
              <div class="small muted">Your referral link</div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <input id="referralLink" readonly style="min-width:0;padding:8px">
                <button id="copyReferral" class="nav-btn">Copy</button>
              </div>
            </div>

            <div style="margin-top:12px">
              <div class="small muted">Add referral by OPAY account</div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <input id="referralPhoneInput" placeholder="Referral OPAY account (10-11 digits)" type="tel" maxlength="11">
                <button id="submitReferral" class="btn" style="background:var(--accent)"><i class="fas fa-plus"></i></button>
              </div>
            </div>

            <div style="margin-top:12px">
              <div class="flex-between small muted"><span>Referrals:</span><span id="referralCount">0</span></div>
              <div class="flex-between small muted" style="margin-top:6px"><span>Confirmed:</span><span id="confirmedReferrals">0</span></div>
            </div>

            <div style="margin-top:12px">
              <button id="requestPayout" class="btn" style="width:100%">Request Payout</button>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>Proofs</h3>
            <div id="proofList" style="max-height:200px;overflow:auto;margin-top:8px"><div class="center small muted">No proofs yet</div></div>
            <div style="margin-top:10px"><button id="addProofBtn" class="nav-btn" style="width:100%"><i class="fas fa-plus-circle"></i>&nbsp;Add Proof</button></div>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <footer><div class="container small muted">CO-YUM — dark, clear, affiliate-first demo. Local demo only.</div></footer>

  <!-- Modals -->
  <div id="modalLogin" class="modal" style="display:none;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:90">
    <div class="panel" style="max-width:520px">
      <div class="flex-between"><h3>Login — OPAY account</h3><button class="nav-btn" data-modal="modalLogin" aria-label="close">&times;</button></div>
      <div style="margin-top:12px"><input id="inputAcct" placeholder="Enter OPAY account (10-11 digits only)" type="tel" maxlength="11"></div>
      <div class="small muted" style="margin-top:6px">Demo accounts are stored locally only.</div>
      <div style="margin-top:12px" class="flex"><button id="doLogin" class="btn">Login</button><button class="nav-btn" data-modal="modalLogin">Cancel</button></div>
    </div>
  </div>

  <div id="modalAdmin" class="modal" style="display:none;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:90">
    <div class="panel" style="max-width:760px">
      <div class="flex-between"><h3>Admin</h3><button class="nav-btn" data-modal="modalAdmin">&times;</button></div>
      <div style="margin-top:10px" class="flex">
        <input id="adminPass" type="password" placeholder="Admin password (default: admin123)">
        <button id="adminLoginBtn" class="btn">Unlock</button>
      </div>
      <div id="adminArea" style="display:none;margin-top:12px">
        <h4>Config</h4>
        <div style="margin-top:8px"><input id="sellerPhone" placeholder="Seller phone (e.g. +2348103606602)"></div>
        <div style="margin-top:8px" class="flex">
          <input id="affiliateBonus" type="number" placeholder="Affiliate bonus (500)" min="0">
          <input id="minPayout" type="number" placeholder="Min payout (1000)" min="0">
        </div>
        <h4 style="margin-top:12px">Data</h4>
        <div class="flex" style="margin-top:8px">
          <button id="exportData" class="btn">Export</button>
          <button id="importDataBtn" class="nav-btn">Import</button>
          <input id="importFile" type="file" accept=".json" style="display:none">
        </div>
        <h4 style="margin-top:12px">Payouts</h4>
        <div id="payoutsAdmin" style="margin-top:8px"></div>
        <div style="margin-top:12px"><button id="processAllPayouts" class="btn" style="background:var(--accent)">Process all pending</button></div>
      </div>
    </div>
  </div>

  <div id="modalAffiliate" class="modal" style="display:none;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:90">
    <div class="panel" style="max-width:700px">
      <div class="flex-between"><h3>Affiliate</h3><button class="nav-btn" data-modal="modalAffiliate">&times;</button></div>
      <div style="margin-top:12px">
        <h4>Your referrals</h4>
        <div id="referralsList" style="max-height:280px;overflow:auto;margin-top:8px"><div class="center small muted">No referrals yet</div></div>
      </div>
      <div style="margin-top:12px">
        <h4>Payouts</h4>
        <div id="payoutsList" style="max-height:220px;overflow:auto;margin-top:8px"><div class="center small muted">No payout requests</div></div>
      </div>
    </div>
  </div>

  <div id="modalProof" class="modal" style="display:none;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:90">
    <div class="panel" style="max-width:560px">
      <div class="flex-between"><h3>Add proof</h3><button class="nav-btn" data-modal="modalProof">&times;</button></div>
      <div style="margin-top:10px">
        <textarea id="proofText" rows="4" placeholder="Payment screenshot link or notes"></textarea>
        <div style="margin-top:10px" class="flex"><button id="saveProof" class="btn">Save</button><button class="nav-btn" data-modal="modalProof">Cancel</button></div>
      </div>
    </div>
  </div>

<script>
/* CO-YUM — dark UI, affiliate-first, updated products
   - removed Veggie Delight & Premium Fruit Smoothie
   - added Five Alive Puppy (Big Size) for ₦500
   - UI tuned for clarity, black background, white text, blue accents
*/

const STORE_KEY = 'coyum_v12_dark';
const DEFAULT = {
  products: [
    { id:'s1', title:'Classic Chicken Sandwich', desc:'Tender chicken, crisp lettuce, signature sauce on toasted bread.', price:2500, img:'sandwich.jpg', badge: 'Best seller', type:'sandwich' },
    { id:'s2', title:'Five Alive Puppy (Big Size)', desc:'Big, refreshing Five Alive — puppy size (500ml).', price:500, img:'fivealive.jfif', badge: 'Drink', type:'drink' }
  ],
  users:{},
  referrals:[],
  payouts:[],
  proofs:[],
  config:{ sellerPhone:'+2348103606602', adminPass:'admin123', affiliateBonus:500, minPayout:1000 }
};

function loadState(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw){ localStorage.setItem(STORE_KEY, JSON.stringify(DEFAULT)); return JSON.parse(JSON.stringify(DEFAULT)); }
    const parsed = JSON.parse(raw);
    parsed.products = parsed.products || DEFAULT.products;
    parsed.users = parsed.users || {};
    parsed.referrals = parsed.referrals || [];
    parsed.payouts = parsed.payouts || [];
    parsed.proofs = parsed.proofs || [];
    parsed.config = Object.assign({}, DEFAULT.config, parsed.config || {});
    return parsed;
  }catch(e){
    console.error('load error',e);
    localStorage.setItem(STORE_KEY, JSON.stringify(DEFAULT));
    return JSON.parse(JSON.stringify(DEFAULT));
  }
}
function saveState(s){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(s)); return true }catch(e){ console.error(e); return false } }

let state = loadState();
let currentUser = null;
let cart = {};

const $ = id => document.getElementById(id);
const notify = (m) => { const n=$('notification'); const t=$('notificationText'); t.textContent=m; n.style.display='block'; setTimeout(()=>n.style.display='none',3000); };
function uid(len=7){ return Math.random().toString(36).slice(2,2+len) }
function formatN(n){ return '₦'+Number(n).toLocaleString() }
function now(){ return new Date().toISOString() }

// DOM refs
const productsEl = $('products'); const cartListEl = $('cartList'); const cartTotalEl = $('cartTotal');
const sellerPhoneDisplay = $('sellerPhoneDisplay'); const welcomeEl = $('welcome');
const acctNumberEl = $('acctNumber'); const affiliateBalanceEl = $('affiliateBalance');
const referralCountEl = $('referralCount'); const confirmedReferralsEl = $('confirmedReferrals');
const referralsListEl = $('referralsList'); const payoutsListEl = $('payoutsList'); const proofListEl = $('proofList');
const referralLinkEl = $('referralLink');

// renderers
function renderProducts(query=''){
  productsEl.innerHTML='';
  const list = state.products.filter(p=>!query || (p.title+' '+p.desc).toLowerCase().includes(query.toLowerCase()));
  list.forEach(p=>{
    const div=document.createElement('div'); div.className='product';
    div.innerHTML = `
      <div class="img-wrap">
        ${p.badge?`<span class="badge">${p.badge}</span>`:''}
        <img src="${p.img||''}" alt="${p.title}" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;800&quot; height=&quot;400&quot;><rect width=&quot;100%&quot; height=&quot;100%&quot; fill=&quot;%23010a10&quot;/><text x=&quot;50%&quot; y=&quot;50%&quot; fill=&quot;%23ffffff&quot; font-family=&quot;Arial&quot; font-size=&quot;24&quot; dominant-baseline=&quot;middle&quot; text-anchor=&quot;middle&quot;>Image</text></svg>'">
      </div>
      <div class="body">
        <div>
          <div class="title">${p.title}</div>
          <div class="desc">${p.desc}</div>
        </div>
        <div class="footer">
          <div class="price">${formatN(p.price)}</div>
          <div>
            <button class="nav-btn" data-id="${p.id}" data-action="view"><i class="fas fa-eye"></i></button>
            <button class="btn" data-id="${p.id}" data-action="add"><i class="fas fa-plus"></i>&nbsp;Add</button>
          </div>
        </div>
      </div>
    `;
    productsEl.appendChild(div);
  });
}

function renderCart(){
  cartListEl.innerHTML='';
  const ids = Object.keys(cart);
  if(!ids.length){ cartListEl.innerHTML = '<div class="center small muted">Cart is empty</div>'; cartTotalEl.textContent=formatN(0); return; }
  ids.forEach(id=>{
    const qty = cart[id]; const p = state.products.find(x=>x.id===id); if(!p) return;
    const div=document.createElement('div'); div.className='cart-item';
    div.innerHTML = `
      <div style="flex:1">
        <div style="font-weight:800">${p.title}</div>
        <div class="small muted">${qty} x ${formatN(p.price)}</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:900">${formatN(p.price*qty)}</div>
        <div style="margin-top:6px">
          <button class="nav-btn" data-id="${p.id}" data-action="dec">-</button>
          <span style="margin:0 8px">${qty}</span>
          <button class="nav-btn" data-id="${p.id}" data-action="inc">+</button>
        </div>
      </div>
    `;
    cartListEl.appendChild(div);
  });
  cartTotalEl.textContent = formatN(getCartTotal());
}

function getCartTotal(){ return Object.keys(cart).reduce((s,id)=>{ const p=state.products.find(x=>x.id===id); return s + (p ? p.price*cart[id] : 0) },0) }

function renderProfile(){
  if(currentUser){
    welcomeEl.textContent = `Hi, ${currentUser.acct}`; acctNumberEl.textContent = currentUser.acct;
    const purchases = (currentUser.purchases||[]).length; $('weekPurchases').textContent = purchases;
    affiliateBalanceEl.textContent = currentUser.affiliateBalance || 0;
    const myRefs = state.referrals.filter(r=>r.affiliate===currentUser.acct);
    referralCountEl.textContent = myRefs.length;
    confirmedReferralsEl.textContent = myRefs.filter(r=>r.status==='confirmed').length;
    updateReferralLink();
  } else {
    welcomeEl.textContent='Not logged in'; acctNumberEl.textContent='—'; $('weekPurchases').textContent=0;
    affiliateBalanceEl.textContent='0'; referralCountEl.textContent='0'; confirmedReferralsEl.textContent='0';
    referralLinkEl.value='';
  }
}

function renderReferralsList(){
  const list = currentUser ? state.referrals.filter(r=>r.affiliate===currentUser.acct) : [];
  const container = referralsListEl; container.innerHTML='';
  if(!list.length){ container.innerHTML='<div class="center small muted">No referrals yet</div>'; return; }
  list.forEach(r=>{
    const div=document.createElement('div'); div.className='referral-row';
    div.innerHTML = `<div><strong>${r.referred}</strong><div class="small muted">${new Date(r.addedAt).toLocaleString()}</div></div><div class="${r.status==='pending'?'status-pending':r.status==='confirmed'?'status-confirmed':'status-paid'}">${r.status}</div>`;
    container.appendChild(div);
  });
}

function renderPayoutsList(){
  const list = currentUser ? state.payouts.filter(p=>p.affiliate===currentUser.acct) : [];
  const container = payoutsListEl; container.innerHTML='';
  if(!list.length){ container.innerHTML='<div class="center small muted">No payout requests</div>'; return; }
  list.forEach(p=>{
    const div=document.createElement('div'); div.className='referral-row';
    div.innerHTML = `<div><strong>${formatN(p.amount)}</strong><div class="small muted">${p.note || ''} • ${new Date(p.requestedAt).toLocaleString()}</div></div><div class="${p.status==='pending'?'status-pending':p.status==='processed'?'status-paid':'status-confirmed'}">${p.status}</div>`;
    container.appendChild(div);
  });
}

function renderProofs(){
  proofListEl.innerHTML='';
  if(!state.proofs.length){ proofListEl.innerHTML = '<div class="small muted center">No proofs yet</div>'; return; }
  state.proofs.slice().reverse().forEach(p=>{
    const div=document.createElement('div'); div.className='referral-row';
    div.innerHTML = `<div style="flex:1"><div style="font-weight:800">${p.text}</div><div class="small muted">${new Date(p.date).toLocaleString()}</div></div><div class="small muted">${p.by||'—'}</div>`;
    proofListEl.appendChild(div);
  });
}

// utils & actions
function updateReferralLink(){
  if(!currentUser){ referralLinkEl.value=''; return; }
  const origin = location.origin === 'null' ? 'https://coyum.example' : location.origin;
  referralLinkEl.value = `${origin}${location.pathname}?ref=${encodeURIComponent(currentUser.acct)}`;
}

function addToCart(id){ cart[id] = (cart[id]||0) + 1; renderCart(); }
function decCart(id){ if(!cart[id]) return; cart[id]--; if(cart[id]<=0) delete cart[id]; renderCart(); }
function incCart(id){ cart[id] = (cart[id]||0) + 1; renderCart(); }

function checkoutWhatsApp(){
  if(Object.keys(cart).length===0){ notify('Cart is empty'); return; }
  const total = getCartTotal();
  const items = Object.keys(cart).map(id=>{ const p=state.products.find(x=>x.id===id); return `${p.title} x${cart[id]} (${formatN(p.price*cart[id])})`}).join('%0A');
  const phone = state.config.sellerPhone || '+2348103606602';
  const text = `Hello! I want to order:%0A${items}%0ATotal: ${formatN(total)}%0AAccount: ${currentUser?currentUser.acct:''}`;
  const url = `https://wa.me/${phone.replace(/\D/g,'')}?text=${text}`;
  window.open(url,'_blank');
  // store purchases locally for demo and affiliate confirmation
  if(currentUser){
    const purchases = currentUser.purchases || [];
    Object.keys(cart).forEach(id=>{
      const p = state.products.find(x=>x.id===id);
      for(let i=0;i<cart[id];i++){ purchases.push({ id: uid(8), productId: id, price: p.price, type: p.type, date: now() }); }
    });
    currentUser.purchases = purchases; state.users[currentUser.acct] = currentUser; saveState(state);
    // confirm any pending referral where referred is this account
    const ref = state.referrals.find(r=>r.referred===currentUser.acct && r.status==='pending');
    if(ref){ ref.status='confirmed'; ref.confirmedAt = now(); const aff = state.users[ref.affiliate] || { acct: ref.affiliate, affiliateBalance:0 }; aff.affiliateBalance = (aff.affiliateBalance||0) + (state.config.affiliateBonus||0); state.users[ref.affiliate]=aff; saveState(state); notify(`Referral confirmed: ${ref.affiliate} credited ${formatN(state.config.affiliateBonus||0)}`); }
    renderProfile();
  }
  cart = {}; renderCart(); notify('Order opened in WhatsApp (demo).');
}

// affiliates
function submitReferral(referred){
  if(!currentUser){ notify('Login to add referrals'); return; }
  if(!/^\d{10,11}$/.test(referred)){ notify('Enter a valid 10-11 digit account'); return; }
  if(state.referrals.find(r=>r.referred===referred && r.affiliate===currentUser.acct)){ notify('Referral already exists'); return; }
  const rec = { id: uid(), affiliate: currentUser.acct, referred, status:'pending', addedAt: now() };
  state.referrals.push(rec); saveState(state); notify('Referral added'); renderReferralsList(); renderProfile();
}

function requestPayout(){
  if(!currentUser){ notify('Login required'); return; }
  const bal = currentUser.affiliateBalance || 0;
  if(bal < (state.config.minPayout || 1000)){ notify('Insufficient affiliate balance'); return; }
  const rec = { id: uid(), affiliate: currentUser.acct, amount: bal, status:'pending', note:'Payout request', requestedAt: now() };
  state.payouts.push(rec); currentUser.affiliateBalance = 0; state.users[currentUser.acct] = currentUser; saveState(state);
  notify('Payout requested (demo)'); renderPayoutsList(); renderProfile();
}

// admin
let adminUnlocked=false;
function adminUnlock(pass){
  if(pass === state.config.adminPass){ adminUnlocked=true; $('adminArea').style.display='block'; notify('Admin unlocked'); renderAdminPayouts(); } else notify('Invalid password');
}
function renderAdminPayouts(){
  const container = $('payoutsAdmin'); container.innerHTML='';
  if(!state.payouts.length){ container.innerHTML='<div class="small muted center">No payouts</div>'; return; }
  state.payouts.slice().reverse().forEach(p=>{
    const div=document.createElement('div'); div.className='referral-row';
    div.innerHTML = `<div style="flex:1"><strong>${formatN(p.amount)}</strong><div class="small muted">${p.affiliate} • ${new Date(p.requestedAt).toLocaleString()}</div></div><div><button class="nav-btn" data-id="${p.id}" data-action="process">Process</button> <button class="nav-btn" data-id="${p.id}" data-action="cancel">Cancel</button></div>`;
    container.appendChild(div);
  });
}
function processPayout(id){
  const p = state.payouts.find(x=>x.id===id); if(!p) return;
  p.status='processed'; p.processedAt = now(); saveState(state); renderAdminPayouts(); renderPayoutsList(); notify('Payout processed (demo)');
}
function cancelPayout(id){
  const i = state.payouts.findIndex(x=>x.id===id); if(i<0) return;
  const p = state.payouts[i];
  const user = state.users[p.affiliate] || { acct: p.affiliate, affiliateBalance:0 };
  user.affiliateBalance = (user.affiliateBalance||0) + p.amount; state.users[p.affiliate]=user;
  state.payouts.splice(i,1); saveState(state); renderAdminPayouts(); renderPayoutsList(); renderProfile(); notify('Payout cancelled & refunded');
}

// export/import
function exportData(){ const data = JSON.stringify(state,null,2); const blob = new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='coyum-data.json'; a.click(); URL.revokeObjectURL(url); }
function importDataFile(file){ const reader=new FileReader(); reader.onload=e=>{ try{ const parsed=JSON.parse(e.target.result); state = Object.assign({}, DEFAULT, parsed); saveState(state); notify('Data imported'); location.reload(); }catch(err){ notify('Invalid file'); } }; reader.readAsText(file); }

// proofs
function saveProof(text){ if(!text||!text.trim()){ notify('Enter proof'); return; } state.proofs.push({ id: uid(), text: text.trim(), date: now(), by: currentUser?currentUser.acct:'guest' }); saveState(state); renderProofs(); notify('Proof saved'); }

// login
function doLogin(acct){
  if(!/^\d{10,11}$/.test(acct)){ notify('Account must be 10-11 digits'); return; }
  let user = state.users[acct] || { acct, balance:0, affiliateBalance:0, purchases:[] };
  state.users[acct] = user; saveState(state); currentUser = user; renderProfile(); renderReferralsList(); renderPayoutsList(); notify('Logged in');
}

function ensureDemo(){ if(!Object.keys(state.users).length){ state.users['08000000001'] = { acct:'08000000001', balance:0, affiliateBalance:1500, purchases:[] }; saveState(state); } }

// events
document.addEventListener('click', e=>{
  const btn = e.target.closest('button');
  if(btn){
    const action = btn.dataset.action; const id = btn.dataset.id;
    if(action==='add') addToCart(id);
    if(action==='dec') decCart(id);
    if(action==='inc') incCart(id);
    if(action==='process') processPayout(id);
    if(action==='cancel') cancelPayout(id);
    if(btn.id==='checkoutBtn') checkoutWhatsApp();
    if(btn.id==='loginBtn') openModal('modalLogin');
    if(btn.id==='doLogin'){ const acct = $('inputAcct').value.trim(); doLogin(acct); closeModal('modalLogin'); }
    if(btn.id==='openAffiliate') openModal('modalAffiliate');
    if(btn.id==='openAdmin') openModal('modalAdmin');
    if(btn.id==='adminLoginBtn'){ adminUnlock($('adminPass').value.trim()); }
    if(btn.id==='submitReferral'){ submitReferral($('referralPhoneInput').value.trim()); $('referralPhoneInput').value=''; }
    if(btn.id==='requestPayout'){ requestPayout(); }
    if(btn.id==='exportData'){ exportData(); }
    if(btn.id==='addProofBtn'){ openModal('modalProof'); }
    if(btn.id==='saveProof'){ saveProof($('proofText').value); $('proofText').value=''; closeModal('modalProof'); }
    if(btn.id==='copyReferral'){ referralLinkEl.select(); document.execCommand('copy'); notify('Copied'); }
    if(btn.id==='clearSearch'){ $('searchInput').value=''; renderProducts(''); }
    if(btn.id==='processAllPayouts'){ state.payouts.filter(p=>p.status==='pending').forEach(p=>{ p.status='processed'; p.processedAt = now(); }); saveState(state); renderAdminPayouts(); renderPayoutsList(); notify('All pending processed'); }
    if(btn.dataset.modal){ closeModal(btn.dataset.modal); }
  }
});

// import file wiring
$('importDataBtn')?.addEventListener('click', ()=>$('importFile').click());
$('importFile')?.addEventListener('change', (e)=>{ const f=e.target.files[0]; if(f) importDataFile(f); });

// search
$('searchInput')?.addEventListener('input', (e)=>renderProducts(e.target.value));

// modal helpers
function openModal(id){ $(id).style.display='flex'; }
function closeModal(id){ $(id).style.display='none'; }

// init
ensureDemo();
renderProducts('');
renderCart();
renderProfile();
renderReferralsList();
renderPayoutsList();
renderProofs();
sellerPhoneDisplay.textContent = state.config.sellerPhone || '+2348103606602';
updateReferralLink();

// handle ?ref= in URL (lightweight demo)
(function handleRef(){
  const params = new URLSearchParams(location.search); const ref = params.get('ref');
  if(ref && /^\d{10,11}$/.test(ref)){
    if(!state.referrals.find(r=>r.referred===ref && r.affiliate==='__link__')){
      state.referrals.push({ id: uid(), affiliate:'__link__', referred:ref, status:'pending', addedAt: now() }); saveState(state);
    }
  }
})();
</script>
</body>
</html>
